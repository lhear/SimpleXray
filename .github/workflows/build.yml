name: "Build"

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip unit tests"
        required: false
        default: false
        type: boolean
  release:
    types:
      - published

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Explicit Submodule Update
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: Set up Android SDK
        id: setup_sdk
        uses: android-actions/setup-android@v3

      - name: Read Versions
        run: |
          echo "XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOIP_VERSION=$(grep 'GEOIP_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOSITE_VERSION=$(grep 'GEOSITE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "OPENSSL_VERSION=$(grep 'OPENSSL_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup Keystore and Properties
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE }}" > keystore.b64
          base64 -d keystore.b64 > ./store.jks
          rm keystore.b64
          echo "storeFile=store.jks" > ./store.properties
          echo "storePassword=${{ secrets.SIGNING_STORE_PASSWORD }}" >> ./store.properties
          echo "keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}" >> ./store.properties
          echo "keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}" >> ./store.properties

      - name: Download Rules Files
        run: |
          wget https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOIP_VERSION }}/geoip.dat -O ./app/src/main/assets/geoip.dat
          wget https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOSITE_VERSION }}/geosite.dat -O ./app/src/main/assets/geosite.dat

      - name: Cache NDK
        uses: actions/cache@v4
        with:
          path: android-ndk-r28c
          key: ndk-r28c-linux
          restore-keys: |
            ndk-r28c-

      - name: Cache OpenSSL
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: |
            app/src/main/jni/openssl
          key: openssl-android-${{ env.OPENSSL_VERSION }}-ndk-r28c-v1
          restore-keys: |
            openssl-android-${{ env.OPENSSL_VERSION }}-

      - name: Build OpenSSL from Source
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        run: |
          # Set up NDK first
          if [ -z "$(ls -d android-ndk-* 2>/dev/null)" ]; then
            echo "Downloading NDK..."
            wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
            unzip -q android-ndk.zip
            rm android-ndk.zip
          fi
          NDK_HOME=$(realpath android-ndk-*)
          echo "Using NDK: $NDK_HOME"
          
          # Download OpenSSL source
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          cd openssl-${{ env.OPENSSL_VERSION }}
          
          # Create output directory structure
          mkdir -p ../app/src/main/jni/openssl/include
          
          # Function to build OpenSSL for a specific ABI
          build_openssl() {
            local NDK_ARCH=$1
            local OPENSSL_TARGET=$2
            local OUTPUT_ARCH=$3
            local TOOLCHAIN_PREFIX=$4
            
            echo "Building OpenSSL for $OUTPUT_ARCH (target: $OPENSSL_TARGET)..."
            
            # Use modern NDK toolchain directly (no standalone toolchain needed)
            local TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
            export PATH=$TOOLCHAIN_DIR/bin:$PATH
            export CC=$TOOLCHAIN_PREFIX-clang
            export CXX=$TOOLCHAIN_PREFIX-clang++
            export AR=$TOOLCHAIN_DIR/bin/llvm-ar
            export RANLIB=$TOOLCHAIN_DIR/bin/llvm-ranlib
            export STRIP=$TOOLCHAIN_DIR/bin/llvm-strip
            export ANDROID_NDK_HOME=$NDK_HOME
            export ANDROID_NDK_ROOT=$NDK_HOME
            
            # Configure OpenSSL with explicit compiler settings
            # Note: __ANDROID_API__ is already defined by the NDK toolchain (e.g., aarch64-linux-android24-clang)
            # so we don't need to explicitly set it with -D__ANDROID_API__=24
            ./Configure $OPENSSL_TARGET \
              --prefix=/tmp/openssl-$OUTPUT_ARCH \
              CC=$CC \
              CXX=$CXX \
              AR=$AR \
              RANLIB=$RANLIB \
              STRIP=$STRIP \
              no-shared \
              no-ssl3 \
              no-comp
            
            # Build (use -j2 to avoid OOM on GitHub Actions runners)
            make clean
            if ! make -j2; then
              echo "‚ùå ERROR: OpenSSL build failed for $OUTPUT_ARCH"
              exit 1
            fi
            if ! make install_sw; then
              echo "‚ùå ERROR: OpenSSL install failed for $OUTPUT_ARCH"
              exit 1
            fi
            
            # Copy libraries to project
            mkdir -p ../app/src/main/jni/openssl/lib/$OUTPUT_ARCH
            cp /tmp/openssl-$OUTPUT_ARCH/lib/libcrypto.a ../app/src/main/jni/openssl/lib/$OUTPUT_ARCH/
            cp /tmp/openssl-$OUTPUT_ARCH/lib/libssl.a ../app/src/main/jni/openssl/lib/$OUTPUT_ARCH/
            
            # Copy headers (only once)
            if [ ! -d "../app/src/main/jni/openssl/include/openssl" ]; then
              cp -r /tmp/openssl-$OUTPUT_ARCH/include/openssl ../app/src/main/jni/openssl/include/
            fi
            
            make clean
          }
          
          # Build for all ABIs
          build_openssl arm64 android-arm64 arm64-v8a "aarch64-linux-android24"
          build_openssl arm android-arm armeabi-v7a "armv7a-linux-androideabi24"
          build_openssl x86_64 android-x86_64 x86_64 "x86_64-linux-android24"
          build_openssl x86 android-x86 x86 "i686-linux-android24"
          
          cd ..
          
          # Verify OpenSSL build was successful
          echo "üîç Verifying OpenSSL installation..."
          
          REQUIRED_FILES=(
            "../app/src/main/jni/openssl/include/openssl/evp.h"
            "../app/src/main/jni/openssl/include/openssl/aes.h"
            "../app/src/main/jni/openssl/include/openssl/ssl.h"
            "../app/src/main/jni/openssl/include/openssl/crypto.h"
            "../app/src/main/jni/openssl/lib/arm64-v8a/libcrypto.a"
            "../app/src/main/jni/openssl/lib/arm64-v8a/libssl.a"
            "../app/src/main/jni/openssl/lib/armeabi-v7a/libcrypto.a"
            "../app/src/main/jni/openssl/lib/armeabi-v7a/libssl.a"
            "../app/src/main/jni/openssl/lib/x86_64/libcrypto.a"
            "../app/src/main/jni/openssl/lib/x86_64/libssl.a"
            "../app/src/main/jni/openssl/lib/x86/libcrypto.a"
            "../app/src/main/jni/openssl/lib/x86/libssl.a"
          )
          
          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "‚ùå ERROR: OpenSSL build incomplete! Missing files:"
            for file in "${MISSING_FILES[@]}"; do
              echo "   - $file"
            done
            exit 1
          fi
          
          echo "‚úÖ OpenSSL build complete and verified"
          echo "   Headers: $(find ../app/src/main/jni/openssl/include -name '*.h' | wc -l) files"
          echo "   Libraries: $(find ../app/src/main/jni/openssl/lib -name '*.a' | wc -l) files"

      - name: Build OpenSSL for Linux x86_64
        run: |
          # Build OpenSSL for Linux x86_64 (for testing)
          echo "üî® Building OpenSSL for Linux x86_64..."
          
          # Download OpenSSL source if not already available
          if [ ! -d "openssl-${{ env.OPENSSL_VERSION }}" ]; then
            wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
            tar -xzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz
            rm -f openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          fi
          
          cd openssl-${{ env.OPENSSL_VERSION }}
          
          # Configure and build for Linux x86_64
          ./config --prefix=/tmp/openssl-linux-x86_64 no-shared no-ssl3 no-comp -fPIC
          make clean >/dev/null 2>&1 || true
          make -j2
          make install_sw
          
          # Copy to project structure
          mkdir -p ../third_party/openssl/linux/x86_64
          cp -r /tmp/openssl-linux-x86_64/lib ../third_party/openssl/linux/x86_64/
          cp -r /tmp/openssl-linux-x86_64/include ../third_party/openssl/linux/x86_64/
          
          cd ..
          echo "‚úÖ OpenSSL for Linux x86_64 built successfully"

      - name: Build Xray-core from Source with OpenSSL
        env:
          WITH_OPENSSL: 1
        run: |
          # Set up NDK (should already exist from OpenSSL build)
          if [ -z "$(ls -d android-ndk-* 2>/dev/null)" ]; then
            echo "NDK not found, downloading..."
            wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
            unzip -q android-ndk.zip
            rm android-ndk.zip
          fi
          NDK_HOME=$(realpath android-ndk-*)

          # Clone Xray-core source and checkout tag
          git clone https://github.com/XTLS/Xray-core.git
          cd Xray-core
          git checkout ${{ env.XRAY_VERSION }}
          COMMID=$(git rev-parse HEAD | cut -c 1-7)

          # Set common environment variables
          export GOOS=android
          export CGO_ENABLED=1

          # Function to build Xray with OpenSSL for a specific architecture
          build_xray_openssl() {
            local GOARCH=$1
            local OUTPUT_ARCH=$2
            local CC_PATH=$3
            local OPENSSL_DIR=$4
            local EXTRA_FLAGS=${5:-}
            
            echo "Building Xray for $OUTPUT_ARCH with OpenSSL..."
            export GOARCH=$GOARCH
            export CC=$CC_PATH
            
            # Set OpenSSL paths
            export CGO_CFLAGS="-I$OPENSSL_DIR/include"
            export CGO_LDFLAGS="-L$OPENSSL_DIR/lib -static -lcrypto -lssl"
            
            # Build with OpenSSL tag (if supported) or just CGO flags
            go build -tags openssl -o xray -trimpath -buildvcs=false \
              -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" \
              $EXTRA_FLAGS -v ./main
            
            mkdir -p ../app/src/main/jniLibs/$OUTPUT_ARCH
            mv xray ../app/src/main/jniLibs/$OUTPUT_ARCH/libxray.so
            echo "‚úÖ Built: app/src/main/jniLibs/$OUTPUT_ARCH/libxray.so"
          }

          # Build for arm64-v8a
          build_xray_openssl arm64 arm64-v8a \
            "$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang" \
            "../app/src/main/jni/openssl"

          # Build for armeabi-v7a
          export GOARM=7
          build_xray_openssl arm armeabi-v7a \
            "$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang" \
            "../app/src/main/jni/openssl"

          # Build for x86_64 (Android)
          build_xray_openssl amd64 x86_64 \
            "$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang" \
            "../app/src/main/jni/openssl"

          # Build for x86 (Android)
          build_xray_openssl 386 x86 \
            "$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang" \
            "../app/src/main/jni/openssl"

          cd ..

      - name: Verify OpenSSL Linkage
        env:
          WITH_OPENSSL: 1
        run: |
          echo "üîç Verifying OpenSSL linkage in built binaries..."
          chmod +x ./tools/check_openssl_link.sh
          chmod +x ./tools/ci_verify.sh
          
          # Check at least one binary
          if [ -f "app/src/main/jniLibs/arm64-v8a/libxray.so" ]; then
            ./tools/ci_verify.sh app/src/main/jniLibs/arm64-v8a/libxray.so
          else
            echo "‚ö†Ô∏è  Binary not found for verification"
          fi

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run Unit Tests
        if: github.event_name != 'workflow_dispatch' || !inputs.skip_tests
        run: ./gradlew test

      - name: Run Lint
        run: ./gradlew lint

      - name: Upload Test Reports
        if: always() && (github.event_name != 'workflow_dispatch' || !inputs.skip_tests)
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: app/build/reports/tests/
          retention-days: 7

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Find and Copy APKs
        run: |
          mkdir -p apks
          find app/build/outputs/apk/release -name "*.apk" -exec cp {} apks/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplexray-apks
          path: apks/
          if-no-files-found: error
          retention-days: 1

      - name: Get APK Info
        id: apk_info
        run: |
          APK_PATH=$(find apks/ -name "*.apk" -type f 2>/dev/null | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "apk_path=" >> $GITHUB_OUTPUT
            echo "apk_name=" >> $GITHUB_OUTPUT
            echo "apk_size=" >> $GITHUB_OUTPUT
          else
            APK_NAME=$(basename "$APK_PATH")
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
            echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          fi
          echo "commit_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Validate APK File
        if: success() && github.event_name == 'release'
        run: |
          APK_PATH="${{ steps.apk_info.outputs.apk_path }}"
          if [ ! -f "$APK_PATH" ]; then
            echo "‚ùå APK dosyasƒ± bulunamadƒ±: $APK_PATH"
            ls -lah apks/ || echo "apks/ klas√∂r√º bulunamadƒ±"
            exit 1
          fi
          echo "‚úÖ APK dosyasƒ± bulundu: $APK_PATH"
          ls -lh "$APK_PATH"

      - name: Send Telegram Text Message
        if: always()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è  Telegram secrets tanƒ±mlanmamƒ±≈ü, mesaj g√∂nderilmiyor"
            exit 0
          fi

          echo "üì§ Telegram'a metin mesajƒ± g√∂nderiliyor..."

          TEXT="‚úÖ *SimpleXray Build Successful*\n\nüì¶ *APK:* \`${{ steps.apk_info.outputs.apk_name }}\`\nüìä *Size:* ${{ steps.apk_info.outputs.apk_size }}\nüî® *Commit:* \`${{ steps.apk_info.outputs.commit_sha }}\`\nüåø *Branch:* ${{ steps.apk_info.outputs.branch }}\nüë§ *Actor:* ${{ github.actor }}\n‚è∞ *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n\nüîó [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$TEXT\", \"parse_mode\": \"Markdown\"}" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendMessage")

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ Metin mesajƒ± ba≈üarƒ±yla g√∂nderildi"
          else
            echo "‚ùå Metin mesajƒ± g√∂nderilemedi"
            echo "Response Details: $RESPONSE"
          fi

      - name: Send APK File to Telegram
        if: always() && steps.apk_info.outputs.apk_path != ''
        run: |
          APK_PATH="${{ steps.apk_info.outputs.apk_path }}"
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "‚ö†Ô∏è  Telegram secrets tanƒ±mlanmamƒ±≈ü, dosya g√∂nderilmiyor"
            exit 0
          fi

          if [ ! -f "$APK_PATH" ]; then
            echo "‚ùå APK dosyasƒ± bulunamadƒ±: $APK_PATH"
            ls -lah apks/ || echo "apks/ klas√∂r√º bulunamadƒ±"
            exit 1
          fi

          echo "üìé APK dosyasƒ± Telegram'a g√∂nderiliyor..."
          echo "Dosya: $APK_PATH"
          echo "Boyut: $(du -h "$APK_PATH" | cut -f1)"

          RESPONSE=$(curl -s -X POST \
            -F "chat_id=$CHAT_ID" \
            -F "document=@$APK_PATH" \
            -F "caption=üì¶ *SimpleXray APK - Build Successful*\n\nüîó [View Release](https://github.com/${{ github.repository }}/releases)" \
            -F "parse_mode=Markdown" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendDocument")

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ APK dosyasƒ± ba≈üarƒ±yla g√∂nderildi"
          else
            echo "‚ùå APK dosyasƒ± g√∂nderilemedi"
            echo "Response Details: $RESPONSE"
          fi

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: "simplexray-*"
          merge-multiple: true

      - name: Upload artifacts to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e  # Exit on error
          
          if [ ! -d "release" ]; then
            echo "‚ùå ERROR: release directory not found"
            exit 1
          fi
          
          APK_COUNT=$(find release -name "simplexray-*.apk" -type f 2>/dev/null | wc -l)
          if [ "$APK_COUNT" -eq 0 ]; then
            echo "‚ùå ERROR: No APK files found in release/"
            ls -lah release/ || echo "Directory listing failed"
            exit 1
          fi
          
          echo "‚úÖ Found $APK_COUNT APK file(s) to upload"
          TAG="${{ github.event.release.tag_name }}"
          
          # Upload each APK
          for apk in release/simplexray-*.apk; do
            if [ -f "$apk" ]; then
              echo "üì§ Uploading: $(basename "$apk")"
              if gh release upload "$TAG" "$apk" --clobber; then
                echo "‚úÖ Uploaded: $(basename "$apk")"
              else
                echo "‚ùå Failed to upload: $(basename "$apk")"
                exit 1
              fi
            fi
          done
          
          echo "‚úÖ All APKs uploaded successfully"
