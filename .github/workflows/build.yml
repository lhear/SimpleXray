name: "Build"

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip unit tests"
        required: false
        default: false
        type: boolean
  release:
    types:
      - published

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Explicit Submodule Update
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: Set up Android SDK
        id: setup_sdk
        uses: android-actions/setup-android@v3

      - name: Read Versions
        run: |
          echo "XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOIP_VERSION=$(grep 'GEOIP_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOSITE_VERSION=$(grep 'GEOSITE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "OPENSSL_VERSION=$(grep 'OPENSSL_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup Keystore and Properties
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE }}" > keystore.b64
          base64 -d keystore.b64 > ./store.jks
          rm keystore.b64
          echo "storeFile=store.jks" > ./store.properties
          echo "storePassword=${{ secrets.SIGNING_STORE_PASSWORD }}" >> ./store.properties
          echo "keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}" >> ./store.properties
          echo "keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}" >> ./store.properties

      - name: Download Rules Files
        run: |
          wget https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOIP_VERSION }}/geoip.dat -O ./app/src/main/assets/geoip.dat
          wget https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOSITE_VERSION }}/geosite.dat -O ./app/src/main/assets/geosite.dat

      - name: Build Xray-core from Source
        run: |
          # Set up NDK
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)

          # Clone Xray-core source and checkout tag
          git clone https://github.com/XTLS/Xray-core.git
          cd Xray-core
          git checkout ${{ env.XRAY_VERSION }}
          COMMID=$(git rev-parse HEAD | cut -c 1-7)

          # Set common environment variables
          export GOOS=android
          export CGO_ENABLED=1

          # Build for arm64-v8a
          echo "Building for arm64-v8a..."
          export GOARCH=arm64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/arm64-v8a
          mv xray ../app/src/main/jniLibs/arm64-v8a/libxray.so

          # Build for armeabi-v7a
          echo "Building for armeabi-v7a..."
          export GOARCH=arm
          export GOARM=7
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/armeabi-v7a
          mv xray ../app/src/main/jniLibs/armeabi-v7a/libxray.so

          # Build for x86_64
          echo "Building for x86_64..."
          export GOARCH=amd64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/x86_64
          mv xray ../app/src/main/jniLibs/x86_64/libxray.so

          # Build for x86
          echo "Building for x86..."
          export GOARCH=386
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/x86
          mv xray ../app/src/main/jniLibs/x86/libxray.so

      - name: Build OpenSSL from Source
        run: |
          # NDK should already be available from Xray-core build step
          # Find NDK directory (should exist from previous step)
          if [ -z "$(ls -d android-ndk-* 2>/dev/null)" ]; then
            echo "NDK not found, downloading..."
            wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
            unzip -q android-ndk.zip
            rm android-ndk.zip
          fi
          NDK_HOME=$(realpath android-ndk-*)
          echo "Using NDK: $NDK_HOME"
          
          # Download OpenSSL source
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          cd openssl-${{ env.OPENSSL_VERSION }}
          
          # Create output directory structure
          mkdir -p ../app/src/main/jni/openssl/include
          
          # Function to build OpenSSL for a specific ABI
          build_openssl() {
            local NDK_ARCH=$1
            local OPENSSL_TARGET=$2
            local OUTPUT_ARCH=$3
            local TOOLCHAIN_PREFIX=$4
            
            echo "Building OpenSSL for $OUTPUT_ARCH (target: $OPENSSL_TARGET)..."
            
            # Use modern NDK toolchain directly (no standalone toolchain needed)
            local TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
            export PATH=$TOOLCHAIN_DIR/bin:$PATH
            export CC=$TOOLCHAIN_PREFIX-clang
            export CXX=$TOOLCHAIN_PREFIX-clang++
            export AR=$TOOLCHAIN_DIR/bin/llvm-ar
            export RANLIB=$TOOLCHAIN_DIR/bin/llvm-ranlib
            export STRIP=$TOOLCHAIN_DIR/bin/llvm-strip
            export ANDROID_NDK_HOME=$NDK_HOME
            export ANDROID_NDK_ROOT=$NDK_HOME
            
            # Configure OpenSSL with explicit compiler settings
            ./Configure $OPENSSL_TARGET \
              --prefix=/tmp/openssl-$OUTPUT_ARCH \
              CC=$CC \
              CXX=$CXX \
              AR=$AR \
              RANLIB=$RANLIB \
              STRIP=$STRIP \
              no-shared \
              no-ssl3 \
              no-comp \
              -D__ANDROID_API__=24
            
            # Build
            make clean
            make -j$(nproc)
            make install_sw
            
            # Copy libraries to project
            mkdir -p ../app/src/main/jni/openssl/lib/$OUTPUT_ARCH
            cp /tmp/openssl-$OUTPUT_ARCH/lib/libcrypto.a ../app/src/main/jni/openssl/lib/$OUTPUT_ARCH/
            cp /tmp/openssl-$OUTPUT_ARCH/lib/libssl.a ../app/src/main/jni/openssl/lib/$OUTPUT_ARCH/
            
            # Copy headers (only once)
            if [ ! -d "../app/src/main/jni/openssl/include/openssl" ]; then
              cp -r /tmp/openssl-$OUTPUT_ARCH/include/openssl ../app/src/main/jni/openssl/include/
            fi
            
            make clean
          }
          
          # Build for all ABIs
          build_openssl arm64 android-arm64 arm64-v8a "aarch64-linux-android24"
          build_openssl arm android-arm armeabi-v7a "armv7a-linux-androideabi24"
          build_openssl x86_64 android-x86_64 x86_64 "x86_64-linux-android24"
          build_openssl x86 android-x86 x86 "i686-linux-android24"
          
          cd ..
          echo "âœ… OpenSSL build complete"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run Unit Tests
        if: github.event_name != 'workflow_dispatch' || !inputs.skip_tests
        run: ./gradlew test

      - name: Run Lint
        run: ./gradlew lint

      - name: Upload Test Reports
        if: always() && (github.event_name != 'workflow_dispatch' || !inputs.skip_tests)
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: app/build/reports/tests/
          retention-days: 7

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Find and Copy APKs
        run: |
          mkdir -p apks
          find app/build/outputs/apk/release -name "*.apk" -exec cp {} apks/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplexray-apks
          path: apks/
          if-no-files-found: error
          retention-days: 1

      - name: Get APK Info
        id: apk_info
        run: |
          APK_PATH=$(find apks/ -name "*.apk" -type f 2>/dev/null | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "apk_path=" >> $GITHUB_OUTPUT
            echo "apk_name=" >> $GITHUB_OUTPUT
            echo "apk_size=" >> $GITHUB_OUTPUT
          else
            APK_NAME=$(basename "$APK_PATH")
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
            echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          fi
          echo "commit_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Validate APK File
        if: success() && github.event_name == 'release'
        run: |
          APK_PATH="${{ steps.apk_info.outputs.apk_path }}"
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK dosyasÄ± bulunamadÄ±: $APK_PATH"
            ls -lah apks/ || echo "apks/ klasÃ¶rÃ¼ bulunamadÄ±"
            exit 1
          fi
          echo "âœ… APK dosyasÄ± bulundu: $APK_PATH"
          ls -lh "$APK_PATH"

      - name: Send Telegram Text Message
        if: always()
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸  Telegram secrets tanÄ±mlanmamÄ±ÅŸ, mesaj gÃ¶nderilmiyor"
            exit 0
          fi

          echo "ğŸ“¤ Telegram'a metin mesajÄ± gÃ¶nderiliyor..."

          TEXT="âœ… *SimpleXray Build Successful*\n\nğŸ“¦ *APK:* \`${{ steps.apk_info.outputs.apk_name }}\`\nğŸ“Š *Size:* ${{ steps.apk_info.outputs.apk_size }}\nğŸ”¨ *Commit:* \`${{ steps.apk_info.outputs.commit_sha }}\`\nğŸŒ¿ *Branch:* ${{ steps.apk_info.outputs.branch }}\nğŸ‘¤ *Actor:* ${{ github.actor }}\nâ° *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n\nğŸ”— [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$TEXT\", \"parse_mode\": \"Markdown\"}" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendMessage")

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… Metin mesajÄ± baÅŸarÄ±yla gÃ¶nderildi"
          else
            echo "âŒ Metin mesajÄ± gÃ¶nderilemedi"
            echo "Response Details: $RESPONSE"
          fi

      - name: Send APK File to Telegram
        if: always() && steps.apk_info.outputs.apk_path != ''
        run: |
          APK_PATH="${{ steps.apk_info.outputs.apk_path }}"
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸  Telegram secrets tanÄ±mlanmamÄ±ÅŸ, dosya gÃ¶nderilmiyor"
            exit 0
          fi

          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK dosyasÄ± bulunamadÄ±: $APK_PATH"
            ls -lah apks/ || echo "apks/ klasÃ¶rÃ¼ bulunamadÄ±"
            exit 1
          fi

          echo "ğŸ“ APK dosyasÄ± Telegram'a gÃ¶nderiliyor..."
          echo "Dosya: $APK_PATH"
          echo "Boyut: $(du -h "$APK_PATH" | cut -f1)"

          RESPONSE=$(curl -s -X POST \
            -F "chat_id=$CHAT_ID" \
            -F "document=@$APK_PATH" \
            -F "caption=ğŸ“¦ *SimpleXray APK - Build Successful*\n\nğŸ”— [View Release](https://github.com/${{ github.repository }}/releases)" \
            -F "parse_mode=Markdown" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendDocument")

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… APK dosyasÄ± baÅŸarÄ±yla gÃ¶nderildi"
          else
            echo "âŒ APK dosyasÄ± gÃ¶nderilemedi"
            echo "Response Details: $RESPONSE"
          fi

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          pattern: "simplexray-*"
          merge-multiple: true

      - name: Upload artifacts to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for i in release/simplexray-*; do
            gh release upload ${{ github.event.release.tag_name }} $i
          done
