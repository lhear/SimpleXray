name: AI Fixer Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install openai PyGithub gitpython

      - name: Run AI static analysis
        id: analyze
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: python tools/ai_analyze.py

      - name: Create patch if needed
        id: create_patch
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python tools/ai_patch.py

      - name: Post review comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: python tools/ai_pr_commenter.py

      - name: Upload patch as artifact (preview mode)
        if: steps.create_patch.outcome == 'success' && hashFiles('auto.patch') != ''
        uses: actions/upload-artifact@v4
        with:
          name: ai-auto-patch
          path: auto.patch
          retention-days: 7

      # Auto-commit disabled by default for safety
      # Uncomment below if you want auto-commit (requires contents: write permission)
      # - name: Auto commit patch (DISABLED)
      #   if: false && steps.create_patch.outcome == 'success' && hashFiles('auto.patch') != ''
      #   run: |
      #     git config --global user.email "bot@ai"
      #     git config --global user.name "AI Fixer Bot"
      #     git add auto.patch || true
      #     git apply --check auto.patch || exit 0
      #     git apply auto.patch
      #     git commit -m "AI: auto fixes" || echo "no changes"
      #     git push || echo "push failed (permission?)"

