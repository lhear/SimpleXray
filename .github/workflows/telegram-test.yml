name: "Telegram Test"

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "Test tÃ¼rÃ¼"
        required: true
        default: "text"
        type: choice
        options:
          - text
          - file
          - both

jobs:
  telegram-test:
    name: Telegram Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Telegram Text Message
        if: github.event.inputs.test_type == 'text' || github.event.inputs.test_type == 'both'
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âŒ Telegram secrets tanÄ±mlanmamÄ±ÅŸ"
            exit 1
          fi

          echo "ğŸ“¤ Test mesajÄ± gÃ¶nderiliyor..."

          TEXT="ğŸ§ª *Telegram Test - Metin Bildirimi*\n\nâœ… Bu bir deneme mesajÄ±dÄ±r\nğŸ”¨ *Commit:* \`${{ github.sha }}\`\nğŸ‘¤ *Actor:* ${{ github.actor }}\nâ° *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n\nğŸ”— [Repository](https://github.com/${{ github.repository }})"

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$TEXT\", \"parse_mode\": \"Markdown\"}" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendMessage")

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… Metin mesajÄ± baÅŸarÄ±yla gÃ¶nderildi"
          else
            echo "âŒ Metin mesajÄ± gÃ¶nderilemedi"
            exit 1
          fi

      - name: Create Test File
        if: github.event.inputs.test_type == 'file' || github.event.inputs.test_type == 'both'
        run: |
          echo "ğŸ§ª Telegram Test File" > test-message.txt
          echo "Bu bir deneme dosyasÄ±dÄ±r." >> test-message.txt
          echo "" >> test-message.txt
          echo "Workflow: ${{ github.workflow }}" >> test-message.txt
          echo "Actor: ${{ github.actor }}" >> test-message.txt
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> test-message.txt
          ls -lh test-message.txt

      - name: Test Telegram File Upload
        if: github.event.inputs.test_type == 'file' || github.event.inputs.test_type == 'both'
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âŒ Telegram secrets tanÄ±mlanmamÄ±ÅŸ"
            exit 1
          fi

          echo "ğŸ“ Test dosyasÄ± gÃ¶nderiliyor..."

          RESPONSE=$(curl -s -X POST \
            -F "chat_id=$CHAT_ID" \
            -F "document=@test-message.txt" \
            -F "caption=ğŸ§ª *Test DosyasÄ± YÃ¼klendi*" \
            -F "parse_mode=Markdown" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendDocument")

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… Dosya baÅŸarÄ±yla gÃ¶nderildi"
          else
            echo "âŒ Dosya gÃ¶nderilemedi"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "âœ… Test tamamlandÄ±"
          echo "ğŸ“Š Test TÃ¼rÃ¼: ${{ github.event.inputs.test_type }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
